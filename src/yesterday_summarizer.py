"""
yesterday_summarizer.py - ì–´ì œ ë‚ ì§œ ëŒ€í™”ë§Œ ìš”ì•½í•˜ëŠ” ëª¨ë“ˆ

íŒŒì‹±ëœ ëŒ€í™” ì¤‘ ì–´ì œ ë‚ ì§œì˜ ëŒ€í™”ë§Œ í•„í„°ë§í•˜ì—¬ ìš”ì•½ì„ ìƒì„±í•©ë‹ˆë‹¤.

ì‚¬ìš©ë²•:
    python yesterday_summarizer.py <filepath>              # ë‹¨ì¼ íŒŒì¼
    python yesterday_summarizer.py <directory>             # ë””ë ‰í„°ë¦¬ ì¼ê´„
    python yesterday_summarizer.py --llm chatgpt <file>    # LLM ì§€ì •
    python yesterday_summarizer.py                         # ëŒ€í™”í˜• ëª¨ë“œ
"""

import sys
from datetime import datetime, timedelta
from pathlib import Path
from typing import Optional, List

from config import config, LLM_PROVIDERS
from parser import KakaoLogParser
from chat_processor import ChatProcessor
from url_extractor import extract_urls_from_text, save_urls_to_file

logger = config.logger


def get_yesterday_date() -> str:
    """ì–´ì œ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë°˜í™˜."""
    yesterday = datetime.now() - timedelta(days=1)
    return yesterday.strftime("%Y-%m-%d")


class YesterdaySummarizer:
    """ì–´ì œ ë‚ ì§œ ëŒ€í™”ë§Œ ìš”ì•½í•˜ëŠ” í´ë˜ìŠ¤."""
    
    def __init__(self, filepath: Path, provider: Optional[str] = None):
        self.filepath = filepath
        self.parser = KakaoLogParser()
        self.processor = ChatProcessor(provider)
        self.yesterday = get_yesterday_date()
        self.output_file = filepath.parent / f"{filepath.stem}_yesterday_summary.md"

    def run(self) -> bool:
        """ì–´ì œ ë‚ ì§œ ìš”ì•½ ì²˜ë¦¬ë¥¼ ì‹¤í–‰."""
        if not self.filepath.exists():
            logger.error(f"File not found: {self.filepath}")
            return False

        print(f"ğŸ“„ íŒŒì¼: {self.filepath.name}")

        logger.info(f"Parsing file: {self.filepath.name}...")
        parse_result = self.parser.parse(self.filepath)
        
        if not parse_result.messages_by_date:
            print(f"   âš ï¸  íŒŒì‹±ëœ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return False

        if self.yesterday not in parse_result.messages_by_date:
            print(f"   â„¹ï¸  ì–´ì œ({self.yesterday}) ë‚ ì§œì˜ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.")
            return False

        messages = parse_result.messages_by_date[self.yesterday]
        msg_count = len(messages)
        
        print(f"   â–¶ {self.yesterday} ({msg_count}ê°œ ë©”ì‹œì§€) ìš”ì•½ ì¤‘...")
        
        chat_content = "\n".join(messages)
        summary_result = self.processor.process_summary(chat_content)
        
        if "[ERROR]" in summary_result:
            logger.error(f"{self.yesterday} ìš”ì•½ ì‹¤íŒ¨: {summary_result}")
            print(f"   âŒ ìš”ì•½ ì‹¤íŒ¨ (ë¡œê·¸ ì°¸ì¡°)")
            return False
        
        self._save_summary(msg_count, summary_result)
        self._extract_urls()
        
        print(f"   âœ… ì™„ë£Œ: {self.output_file.name}")
        return True

    def _save_summary(self, msg_count: int, summary_md: str):
        with open(self.output_file, 'w', encoding='utf-8') as f:
            f.write(f"# ğŸ“š ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ìš”ì•½ - {self.yesterday}\n")
            f.write(f"- **ì›ë³¸ íŒŒì¼**: {self.filepath.name}\n")
            f.write(f"- **ëŒ€ìƒ ë‚ ì§œ**: {self.yesterday} (ì–´ì œ)\n")
            f.write(f"- **ë©”ì‹œì§€ ìˆ˜**: {msg_count}ê°œ\n")
            f.write(f"- **LLM**: {config.get_provider_info().name}\n")
            f.write(f"- **ìƒì„± ì¼ì‹œ**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write("---\n\n")
            
            clean_summary = self._strip_headers(summary_md)
            f.write(clean_summary)
            f.write("\n\n---\n")
            f.write("_Generated by AI Assistant_\n")

    def _strip_headers(self, text: str) -> str:
        if "# ğŸ“" not in text:
            return text
            
        lines = text.split('\n')
        start_idx = 0
        end_idx = len(lines)
        
        for i, line in enumerate(lines):
            if line.startswith("###"):
                start_idx = i
                break
        
        for i in range(len(lines)-1, -1, -1):
            if "_Generated by" in lines[i]:
                end_idx = i
                break
                
        return "\n".join(lines[start_idx:end_idx]).strip() if start_idx < end_idx else text

    def _extract_urls(self):
        try:
            full_text = self.output_file.read_text(encoding='utf-8')
            url_dict = extract_urls_from_text(full_text)
            
            if url_dict:
                url_filename = f"{self.filepath.stem}_yesterday_url.txt"
                url_path = self.filepath.parent / url_filename
                save_urls_to_file(url_dict, str(url_path), f"{self.filepath.stem} ({self.yesterday})")
                print(f"   ğŸ”— {len(url_dict)}ê°œ URL ì¶”ì¶œ")
        except Exception as e:
            logger.error(f"URL extraction failed: {e}")


class YesterdayBatchProcessor:
    """ë””ë ‰í„°ë¦¬ ë‚´ ëª¨ë“  íŒŒì¼ì—ì„œ ì–´ì œ ë‚ ì§œ ëŒ€í™”ë¥¼ ì¼ê´„ ìš”ì•½."""
    
    def __init__(self, directory: Path, provider: Optional[str] = None):
        self.directory = directory
        self.provider = provider
        self.yesterday = get_yesterday_date()

    def get_target_files(self) -> List[Path]:
        all_txt_files = list(self.directory.glob("*.txt"))
        
        target_files = [
            f for f in all_txt_files
            if "_summary" not in f.name 
            and "_url" not in f.name
            and "_summaries" not in f.name
        ]
        
        return sorted(target_files)

    def run(self):
        if not self.directory.exists() or not self.directory.is_dir():
            print(f"âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ë””ë ‰í„°ë¦¬: {self.directory}")
            return

        target_files = self.get_target_files()
        
        if not target_files:
            print(f"âŒ ì²˜ë¦¬í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.")
            return

        print("="*60)
        print("ğŸ“… ì–´ì œ ë‚ ì§œ ì¼ê´„ ìš”ì•½")
        print("="*60)
        print(f"ğŸ“‚ ë””ë ‰í„°ë¦¬: {self.directory}")
        print(f"ğŸ“… ëŒ€ìƒ ë‚ ì§œ: {self.yesterday} (ì–´ì œ)")
        print(f"ğŸ¤– LLM: {config.get_provider_info().name}")
        print(f"ğŸ“„ íŒŒì¼ ìˆ˜: {len(target_files)}ê°œ")
        print("="*60 + "\n")

        results = []
        
        for filepath in target_files:
            summarizer = YesterdaySummarizer(filepath, self.provider)
            success = summarizer.run()
            results.append((filepath.name, success))
            print()

        self._print_results(results)

    def _print_results(self, results: List[tuple]):
        print("="*60)
        print("ğŸ“‹ ì²˜ë¦¬ ê²°ê³¼")
        print("="*60)
        
        success_count = sum(1 for _, success in results if success)
        skip_count = len(results) - success_count
        
        for filename, success in results:
            status = "âœ… ì„±ê³µ" if success else "â­ï¸  ìŠ¤í‚µ"
            print(f"  {status}: {filename}")
        
        print("-"*60)
        print(f"ì´ {len(results)}ê°œ | âœ… ì„±ê³µ: {success_count} | â­ï¸  ìŠ¤í‚µ: {skip_count}")


def prompt_api_key():
    """API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ëŒ€í™”í˜•ìœ¼ë¡œ ì…ë ¥ ìš”ì²­."""
    if config.get_api_key():
        return

    provider_info = config.get_provider_info()
    print("\n" + "="*50)
    print(f"ğŸ”‘ API ì¸ì¦ ì„¤ì • ({provider_info.name})")
    print("="*50)
    print(f"í™˜ê²½ ë³€ìˆ˜ {provider_info.env_key}ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    
    while True:
        try:
            input_key = input(f"ğŸ‘‰ {provider_info.name} API Key: ").strip()
            if input_key:
                config.set_api_key(input_key)
                print("âœ… API Keyê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n")
                break
            else:
                print("âš ï¸  API KeyëŠ” ë¹„ì–´ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        except KeyboardInterrupt:
            print("\nâŒ í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.")
            sys.exit(0)


def select_llm_provider() -> str:
    """LLM ì œê³µì ì„ íƒ í”„ë¡¬í”„íŠ¸."""
    print("\nğŸ¤– LLM ì œê³µì ì„ íƒ:")
    providers = list(LLM_PROVIDERS.keys())
    for i, key in enumerate(providers, 1):
        info = LLM_PROVIDERS[key]
        print(f"  {i}. {info.name} ({key})")
    
    while True:
        choice = input(f"\nì„ íƒ (1-{len(providers)}, ê¸°ë³¸=1): ").strip()
        if not choice:
            return providers[0]
        if choice.isdigit() and 1 <= int(choice) <= len(providers):
            return providers[int(choice) - 1]
        print("âš ï¸ ì˜¬ë°”ë¥¸ ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.")


def parse_args():
    """ëª…ë ¹ì¤„ ì¸ì íŒŒì‹±."""
    args = sys.argv[1:]
    provider = None
    target = None
    
    i = 0
    while i < len(args):
        if args[i] == "--llm" and i + 1 < len(args):
            provider = args[i + 1]
            i += 2
        else:
            target = args[i]
            i += 1
    
    return target, provider


def main():
    """ë©”ì¸ ì§„ì…ì  í•¨ìˆ˜."""
    yesterday = get_yesterday_date()
    target, provider = parse_args()
    
    # LLM ì œê³µì ì„¤ì •
    if provider:
        if provider not in LLM_PROVIDERS:
            print(f"âŒ ì•Œ ìˆ˜ ì—†ëŠ” LLM: {provider}")
            print(f"   ì‚¬ìš© ê°€ëŠ¥: {', '.join(LLM_PROVIDERS.keys())}")
            sys.exit(1)
        config.set_provider(provider)
    
    print("="*50)
    print(f"ğŸ“… ì–´ì œ ë‚ ì§œ({yesterday}) ëŒ€í™” ìš”ì•½ê¸°")
    print("="*50)
    
    # ëª…ë ¹ì¤„ ì¸ì ì—†ìœ¼ë©´ ëŒ€í™”í˜• ëª¨ë“œ
    if not target:
        print("Usage:")
        print("  python yesterday_summarizer.py <file>")
        print("  python yesterday_summarizer.py <directory>")
        print("  python yesterday_summarizer.py --llm chatgpt <file>\n")
        
        # LLM ì„ íƒ
        selected_provider = select_llm_provider()
        config.set_provider(selected_provider)
        
        # íŒŒì¼/ë””ë ‰í„°ë¦¬ ì„ íƒ
        data_dir = config.data_dir
        if data_dir.exists():
            files = list(data_dir.glob("*.txt"))
            txt_files = [f for f in files if "_summary" not in f.name and "_url" not in f.name]
            
            if txt_files:
                print("\nAvailable files:")
                for i, f in enumerate(txt_files, 1):
                    print(f"  {i}. {f.name}")
                print(f"  A. ì „ì²´ ë””ë ‰í„°ë¦¬ ì²˜ë¦¬")
                
                choice = input("\nSelect (number/A/Enter to exit): ").strip()
                
                if choice.upper() == 'A':
                    prompt_api_key()
                    processor = YesterdayBatchProcessor(data_dir, selected_provider)
                    processor.run()
                    sys.exit(0)
                elif choice.isdigit() and 1 <= int(choice) <= len(txt_files):
                    target_file = txt_files[int(choice)-1]
                    prompt_api_key()
                    summarizer = YesterdaySummarizer(target_file, selected_provider)
                    summarizer.run()
                    sys.exit(0)
        sys.exit(1)

    # ëª…ë ¹ì¤„ ì¸ìë¡œ ê²½ë¡œê°€ ì£¼ì–´ì§„ ê²½ìš°
    target_path = Path(target).resolve()
    prompt_api_key()
    
    if target_path.is_dir():
        processor = YesterdayBatchProcessor(target_path, provider)
        processor.run()
    else:
        summarizer = YesterdaySummarizer(target_path, provider)
        summarizer.run()


if __name__ == "__main__":
    main()
