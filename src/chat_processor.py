"""
chat_processor.py - ì±„íŒ… í…ìŠ¤íŠ¸ ì²˜ë¦¬ ëª¨ë“ˆ

ì´ ëª¨ë“ˆì€ ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” í…ìŠ¤íŠ¸ë¥¼ ë°›ì•„ LLM APIë¥¼ í†µí•´ ìš”ì•½í•˜ê³ ,
Markdown í˜•ì‹ìœ¼ë¡œ ê²°ê³¼ë¥¼ í¬ë§·íŒ…í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.
"""

from datetime import datetime
from typing import Optional
from full_config import config
from llm_client import LLMClient


class ChatProcessor:
    """
    ì±„íŒ… í…ìŠ¤íŠ¸ ì²˜ë¦¬ í´ë˜ìŠ¤.
    
    LLM APIë¥¼ í†µí•´ ëŒ€í™”ë¥¼ ìš”ì•½í•˜ê³ , ê²°ê³¼ë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
    """
    
    def __init__(self, provider: Optional[str] = None):
        """
        ChatProcessor ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
        
        Args:
            provider: LLM ì œê³µì (glm, chatgpt, minimax, perplexity)
        """
        self.client = LLMClient(provider)
        self.logger = config.logger

    def process_summary(self, text: str) -> str:
        """
        ëŒ€í™” í…ìŠ¤íŠ¸ë¥¼ ìš”ì•½í•©ë‹ˆë‹¤.
        
        Args:
            text: ìš”ì•½í•  ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” í…ìŠ¤íŠ¸
            
        Returns:
            Markdown í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…ëœ ìš”ì•½ ê²°ê³¼ ë¬¸ìì—´.
            ì‹¤íŒ¨ ì‹œ '[ERROR]'ë¡œ ì‹œì‘í•˜ëŠ” ì—ëŸ¬ ë©”ì‹œì§€ ë°˜í™˜.
        """
        self.logger.info("=== Chat Processing Started ===")
        
        result = self.client.summarize(text)
        
        if not result["success"]:
            error_msg = f"[ERROR] Summary failed: {result.get('error')}"
            self.logger.error(error_msg)
            return error_msg

        raw_content = result["content"]
        tokens = result.get("usage", {})
        self.logger.info(f"API Call Success. Tokens used: {tokens}")

        return self._format_as_markdown(raw_content)

    def _format_as_markdown(self, content: str) -> str:
        """
        ìš”ì•½ ê²°ê³¼ë¥¼ Markdown í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…í•©ë‹ˆë‹¤.
        """
        header = "# ğŸ“ ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ìš”ì•½ ë¦¬í¬íŠ¸\n\n"
        header += f"**ìƒì„± ì¼ì‹œ**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n"
        header += f"**LLM**: {config.get_provider_info().name}\n"
        header += "---\n\n"
        
        footer = "\n\n---\n"
        footer += "_Generated by AI Assistant_\n"
        
        return header + content.strip() + footer
